	bits 64
	default rel

	segment .data

	msg_hello 	db 	"Hello world!", 0xd, 0xa, 0
	msg_exec_addr	db 	"exec_mem addr", 0
	msg_pload_addr	db 	"payload addr", 0	
	msg_format	db	"%-20s : 0x%-016p", 0xd, 0xa, 0
	payload 	db	0x90, 0x90, 0xCC, 0xC3
	payload_len 	db	4

	segment .text
	global main
	extern _CRT_INIT	
	extern ExitProcess
	extern printf
	extern VirtualAlloc

main:
	push    rbp
	mov     rbp, rsp
	sub     rsp, 32

	mov	rcx, 0
	mov	rdx, 4
	mov	r8, 0x3000
	mov	r9, 0x4
	call	VirtualAlloc

	push	rax
	sub	rsp, 32
	lea     rcx, [msg_format]
	lea	rdx, [msg_pload_addr]
	lea	r8, payload
	call    printf
	add	rsp, 32
	pop	rax
	
	lea     rcx, [msg_format]
	lea	rdx, [msg_exec_addr]
	mov	r8, rax
	call    printf

	xor     rax, rax
	call    ExitProcess
